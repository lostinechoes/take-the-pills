<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pill Time Reminder</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#8B5CF6">
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
    .app-container { max-width: 420px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
    .reminder-card { box-shadow: 0 2px 8px rgba(0,0,0,0.05); transition: all 0.2s cubic-bezier(0.175,0.885,0.32,1.275); }
    .reminder-card:hover { transform: translateY(-4px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
    .weekly-tile { cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
    .weekly-tile:not(.active):hover { background-color: #eef2ff; border-color: #c7d2fe; }
    .weekly-tile.active { background-color: #8b5cf6; color: white; transform: scale(1.05); box-shadow: 0 6px 10px -3px rgba(139,92,246,0.5); }
    .weekly-tile.active .pill-count { color: white !important; }
    #reminder-list::-webkit-scrollbar { width: 6px; }
    #reminder-list::-webkit-scrollbar-thumb { background-color: #c5c5c5; border-radius: 10px; }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

  <!-- Status Banner -->
  <div id="status-banner" class="fixed top-0 left-0 w-full text-center py-2 text-sm font-semibold hidden"></div>

  <div class="w-full bg-white rounded-2xl p-6 space-y-6 app-container">
    <header class="text-center">
      <h1 class="text-3xl font-extrabold text-purple-700 mb-1">Pill Time ðŸ’Š</h1>
      <p class="text-sm text-gray-500">Your scheduled medicine intake</p>
      <p id="user-id-display" class="text-xs text-gray-300 mt-2">Authenticating user...</p>
      <button id="google-login-btn" class="hidden mt-4 w-full flex items-center justify-center py-2 px-4 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
        Sign In with Google (Save Data)
      </button>
    </header>

    <!-- Weekly Schedule -->
    <section class="bg-gray-50 p-3 rounded-xl shadow-inner">
      <h2 class="text-lg font-semibold text-gray-700 mb-3">Weekly At-a-Glance</h2>
      <div id="weekly-summary" class="grid grid-cols-7 gap-2 overflow-x-auto"></div>
    </section>

    <!-- Detailed Reminder List -->
    <section>
      <h2 id="schedule-title" class="text-xl font-bold text-gray-700 mb-3">Schedule</h2>
      <div id="reminder-list" class="space-y-3 max-h-80 overflow-y-auto p-1">
        <p id="empty-state" class="text-center text-gray-400 py-4">Select a day above to view its schedule.</p>
      </div>
    </section>

    <!-- History of Taken Meds -->
    <section class="bg-gray-50 p-3 rounded-xl shadow-inner mt-4">
      <h2 class="text-lg font-semibold text-gray-700 mb-3">History of Taken Meds</h2>
      <div class="flex space-x-2 mb-2">
        <button id="clear-history-btn" class="px-3 py-1 text-xs rounded bg-red-500 text-white">Clear History</button>
        <button id="download-history-btn" class="px-3 py-1 text-xs rounded bg-blue-500 text-white">Download History</button>
      </div>
      <div id="history-list" class="space-y-2 max-h-40 overflow-y-auto p-1">
        <p class="text-center text-gray-400 py-2">No history yet.</p>
      </div>
    </section>

    <!-- Add Reminder Form -->
    <form id="reminder-form" class="space-y-4 bg-white p-4 rounded-xl border border-gray-200 shadow-lg">
      <h2 class="text-xl font-bold text-gray-700">Add New Intake</h2>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label for="medicine-name" class="block text-sm font-medium text-gray-600">Medicine Name</label>
          <input type="text" id="medicine-name" required placeholder="e.g., Vitamin C" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
        </div>
        <div>
          <label for="intake-date" class="block text-sm font-medium text-gray-600">Date</label>
          <input type="date" id="intake-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
        </div>
      </div>
      <div>
        <label for="intake-time" class="block text-sm font-medium text-gray-600">Intake Time</label>
        <input type="time" id="intake-time" required value="08:00" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500 sm:text-sm">
      </div>
      <button type="submit" id="add-button" class="w-full flex justify-center py-2.5 px-4 border border-transparent rounded-lg shadow-md text-sm font-semibold text-white bg-purple-600 hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 transition duration-150 ease-in-out">
        Add Reminder
      </button>
    </form>
  </div>
  
  <script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./service-worker.js")
      .then(() => console.log("Service Worker registered"))
      .catch(err => console.error("Service Worker registration failed:", err));
    }
  </script>

  <!-- Firebase SDKs -->
  <script>
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getAuth, signInAnonymously, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import { getFirestore, collection, query, onSnapshot, addDoc, deleteDoc, doc, where, updateDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    import { firebaseConfig } from "./scripts/firebase-config.js";
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    enableIndexedDbPersistence(db).catch(err => console.warn("Persistence issue:", err));

    let activeDateString = new Date().toISOString().split('T')[0]; // Default highlight = Today

    // Status banner
    const statusBanner = document.getElementById('status-banner');
    const showStatus = (msg, cls) => { statusBanner.textContent = msg; statusBanner.className = `fixed top-0 left-0 w-full text-center py-2 text-sm font-semibold ${cls}`; statusBanner.classList.remove('hidden'); };
    const hideStatus = () => statusBanner.classList.add('hidden');
    window.addEventListener('online', () => { showStatus("Back online â€” syncing dataâ€¦","bg-green-500 text-white"); setTimeout(hideStatus,3000); });
    window.addEventListener('offline', () => { showStatus("Youâ€™re offline â€” changes will sync later","bg-yellow-500 text-black"); });

    // Firestore helpers
    const getRemindersCollectionRef = (uid) => collection(db, `users/${uid}/reminders`);

    const addReminder = async (uid, name, date, time) => {
      await addDoc(getRemindersCollectionRef(uid), {
        name, date, time,
        isTaken: false,
        takenAt: null,
        created_at: new Date().toISOString()
      });
    };

    const toggleTakenStatus = async (uid, docId, currentStatus) => {
      await updateDoc(doc(getRemindersCollectionRef(uid), docId), {
        isTaken: !currentStatus,
        takenAt: !currentStatus ? new Date().toISOString() : null
      });
    };

    const deleteReminder = async (uid, docId) => {
      await deleteDoc(doc(getRemindersCollectionRef(uid), docId));
    };

    // --- Daily Reminders Rendering ---
    const reminderListElement = document.getElementById('reminder-list');
    const scheduleTitle = document.getElementById('schedule-title');
    let activeDateString = new Date().toISOString().split('T')[0]; // Default highlight = Today

    const renderDailyReminders = (dateString, reminders) => {
      reminderListElement.innerHTML = '';
      if (reminders.length === 0) {
        reminderListElement.innerHTML = `<p class="text-center text-gray-400 py-4">No reminders for this day.</p>`;
        return;
      }
      reminders.forEach(rem => {
        const card = document.createElement('div');
        card.className = "reminder-card flex justify-between items-center p-3 rounded-lg bg-gray-50";
        card.innerHTML = `
          <div>
            <p class="font-semibold text-gray-700">${rem.name}</p>
            <p class="text-xs text-gray-500">${rem.time}</p>
          </div>
          <div class="flex space-x-2">
            <button class="px-2 py-1 text-xs rounded ${rem.isTaken ? 'bg-green-500 text-white' : 'bg-purple-500 text-white'}">
              ${rem.isTaken ? 'Taken' : 'Mark Taken'}
            </button>
            <button class="px-2 py-1 text-xs rounded bg-red-500 text-white">Delete</button>
          </div>
        `;
        card.querySelector('button').addEventListener('click', () => {
          toggleTakenStatus(auth.currentUser.uid, rem.id, rem.isTaken);
        });
        card.querySelectorAll('button')[1].addEventListener('click', () => {
          deleteReminder(auth.currentUser.uid, rem.id);
        });
        reminderListElement.appendChild(card);
      });
    };

    // --- History Rendering ---
    const historyListElement = document.getElementById('history-list');
    const renderHistory = (takenReminders) => {
      historyListElement.innerHTML = '';
      if (takenReminders.length === 0) {
        historyListElement.innerHTML = `<p class="text-center text-gray-400 py-2">No history yet.</p>`;
        return;
      }
      takenReminders.forEach(rem => {
        const item = document.createElement('div');
        item.className = "flex justify-between items-center p-2 rounded-lg bg-white shadow-sm";
        item.innerHTML = `
          <span class="text-sm text-gray-700">${rem.name} â€” ${rem.date} ${rem.time}</span>
          <span class="text-xs text-gray-500">Taken at ${rem.takenAt ? new Date(rem.takenAt).toLocaleString() : ''}</span>
        `;
        historyListElement.appendChild(item);
      });
    };

    // --- Weekly Summary ---
    const weeklySummaryElement = document.getElementById('weekly-summary');
    const renderWeeklySummary = (remindersByDate, takenReminders) => {
      weeklySummaryElement.innerHTML = '';
      const today = new Date();
      for (let i = 0; i < 7; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        const dateString = date.toISOString().split('T')[0];
        const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
        const dayReminders = remindersByDate[dateString] || [];
        const totalCount = dayReminders.length;
        const takenCount = dayReminders.filter(r => r.isTaken).length;
        const countText = totalCount > 0 ? `${takenCount}/${totalCount}` : '0';
        const pillColorClass = (totalCount > 0 && takenCount === totalCount) ? 'bg-green-500' : 
                               (totalCount > 0) ? 'bg-purple-500' : 'bg-gray-300';
        const tile = document.createElement('div');
        tile.className = `weekly-tile flex flex-col items-center p-2 border border-gray-200 rounded-xl text-xs font-medium bg-white ${activeDateString===dateString?'active':''}`;
        tile.innerHTML = `
          <span>${i===0?'Today':i===1?'Tmrw':dayName}</span>
          <span class="pill-count px-2 mt-1 rounded-full ${pillColorClass} text-white">${countText}</span>
        `;
        tile.addEventListener('click', () => {
          activeDateString = dateString;
          scheduleTitle.textContent = `Schedule for ${date.toDateString()}`;
          renderDailyReminders(dateString, dayReminders);
          document.querySelectorAll('.weekly-tile').forEach(t => t.classList.remove('active'));
          tile.classList.add('active');
        });
        weeklySummaryElement.appendChild(tile);

        // Auto-load today's schedule on first render
        if (i===0 && activeDateString===dateString) {
          scheduleTitle.textContent = `Schedule for ${date.toDateString()}`;
          renderDailyReminders(dateString, dayReminders);
        }
      }
      renderHistory(takenReminders);
    };

    const loadWeeklySummary = (uid) => {
      const ref = getRemindersCollectionRef(uid);
      const today = new Date();
      const startDateString = today.toISOString().split('T')[0];
      const endDate = new Date();
      endDate.setDate(today.getDate() + 6);
      const endDateString = endDate.toISOString().split('T')[0];
      const q = query(ref, where("date", ">=", startDateString), where("date", "<=", endDateString));
      onSnapshot(q, snapshot => {
        const reminders = {};
        const takenReminders = [];
        snapshot.forEach(docSnap => {
          const data = docSnap.data();
          if (!reminders[data.date]) reminders[data.date] = [];
          reminders[data.date].push({ id: docSnap.id, ...data });
          if (data.isTaken) takenReminders.push({ id: docSnap.id, ...data });
        });
        renderWeeklySummary(reminders, takenReminders);
      });
    };

    // --- Clear History ---
    clearHistoryBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return;
      const ref = getRemindersCollectionRef(user.uid);
      const q = query(ref, where("isTaken", "==", true));
      const snapshot = await getDocs(q);
      snapshot.forEach(async docSnap => {
        await deleteReminder(user.uid, docSnap.id);
      });
    });


    // --- Download History (.txt) ---
    import { getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    downloadHistoryBtn.addEventListener('click', async () => {
      const user = auth.currentUser;
      if (!user) return;
      const ref = getRemindersCollectionRef(user.uid);
      const q = query(ref, where("isTaken", "==", true));
      const snapshot = await getDocs(q);
      let content = "History of Taken Meds\n\n";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        content += `${data.name} â€” ${data.date} ${data.time} | Taken at: ${data.takenAt}\n`;
      });
      const blob = new Blob([content], { type: "text/plain" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "meds-history.txt";
      a.click();
      URL.revokeObjectURL(url);
    });


    // --- Form Handling ---
    const form = document.getElementById('reminder-form');
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      if (!user) return;
      const name = document.getElementById('medicine-name').value;
      const date = document.getElementById('intake-date').value;
      const time = document.getElementById('intake-time').value;
      await addReminder(user.uid, name, date, time);
      form.reset();
    });
  
</script>
</body>
</html>





